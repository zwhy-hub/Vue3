{
  "version": 3,
  "sources": ["../src/system.ts", "../src/effect.ts", "../src/ref.ts"],
  "sourcesContent": ["import { ReactiveEffect } from './effect'\r\n\r\n/**\r\n * \u4F9D\u8D56\u9879\r\n */\r\nexport interface Dep {\r\n  /**\r\n   * \u8BA2\u9605\u8005\u94FE\u8868\u5934\u8282\u70B9\r\n   */\r\n  subs: Link | undefined\r\n  subsTail: Link | undefined\r\n}\r\n\r\n/**\r\n * \u8BA2\u9605\u8005\r\n */\r\nexport interface Sub {\r\n  deps: Link | undefined\r\n  depsTail: Link | undefined\r\n}\r\nexport interface Link {\r\n  //\u8BA2\u9605\u8005\r\n  sub: Sub\r\n  //\u4E0B\u4E00\u4E2A\u8BA2\u9605\u8005\u8282\u70B9\r\n  nextSub: Link | undefined\r\n  //\u4E0A\u4E00\u4E2A\u8BA2\u9605\u8005\u8282\u70B9\r\n  prevSub: Link | undefined\r\n  //\u4F9D\u8D56\u9879\r\n  dep: Dep\r\n  //\u4E0B\u4E00\u4E2A\u4F9D\u8D56\u9879\u8282\u70B9\r\n  nextDep: Link | undefined\r\n}\r\n\r\n/**\r\n * \u94FE\u63A5\u94FE\u8868\u5173\u7CFB\r\n * @param dep\r\n * @param sub\r\n */\r\n\r\nexport function link(dep, sub) {\r\n  //\u590D\u7528\u94FE\u8868\u4F9D\u8D56\r\n  const currentDep = sub.depsTail\r\n  /**\r\n   * \u5982\u679C\u5934\u8282\u70B9\u6709\uFF0C\u5C3E\u8282\u70B9\u6CA1\u6709\uFF0C\u5C1D\u8BD5\u590D\u7528\u5934\u8282\u70B9\r\n   * \u5982\u679C\u5934\u8282\u70B9\u6709\uFF0C\u5C3E\u8282\u70B9\u4E5F\u6709\uFF0C\u5C1D\u8BD5\u590D\u7528nextDep\r\n   */\r\n  const nextDep = currentDep === undefined ? sub.deps : currentDep.nextDep\r\n  if (nextDep && nextDep.dep === dep) {\r\n    sub.depsTail = nextDep\r\n    return\r\n  }\r\n\r\n  const newLink = {\r\n    sub,\r\n    dep,\r\n    nextSub: undefined,\r\n    prevSub: undefined,\r\n    nextDep: undefined,\r\n  }\r\n\r\n  //\u5C06\u94FE\u8868\u8282\u70B9\u4E0Edep\u5EFA\u7ACB\u5173\u7CFB\r\n  /**\r\n   * \u5173\u8054\u94FE\u8868\u5173\u7CFB \u5206\u4E24\u79CD\u60C5\u51B5\r\n   * 1.\u5C3E\u8282\u70B9\u6709\uFF0C\u5F80\u5C3E\u8282\u70B9\u540E\u9762\u52A0\r\n   * 2.\u5C3E\u8282\u70B9\u6CA1\u6709\uFF0C\u7B2C\u4E00\u6B21\u52A0\uFF0C\u52A0\u5230\u5934\u8282\u70B9\r\n   */\r\n  if (dep.subsTail) {\r\n    dep.subsTail.nextSub = newLink\r\n    newLink.prevSub = dep.subsTail\r\n    dep.subsTail = newLink\r\n  } else {\r\n    dep.subs = newLink\r\n    dep.subsTail = newLink\r\n  }\r\n\r\n  //\u5C06\u94FE\u8868\u8282\u70B9\u4E0Esub\u5EFA\u7ACB\u5173\u7CFB\r\n  /**\r\n   * \u5173\u8054\u94FE\u8868\u5173\u7CFB \u5206\u4E24\u79CD\u60C5\u51B5\r\n   * 1.\u5C3E\u8282\u70B9\u6709\uFF0C\u5F80\u5C3E\u8282\u70B9\u540E\u9762\u52A0\r\n   * 2.\u5C3E\u8282\u70B9\u6CA1\u6709\uFF0C\u7B2C\u4E00\u6B21\u52A0\uFF0C\u52A0\u5230\u5934\u8282\u70B9\r\n   */\r\n  if (sub.depsTail) {\r\n    sub.depsTail.nextDep = newLink\r\n    sub.depsTail = newLink\r\n  } else {\r\n    sub.deps = newLink\r\n    sub.depsTail = newLink\r\n  }\r\n}\r\n\r\n/**\r\n * \u4F20\u64AD\u66F4\u65B0\r\n * @param subs\r\n */\r\nexport function propagate(subs) {\r\n  let link = subs\r\n  let queuedEffect = []\r\n  while (link) {\r\n    queuedEffect.push(link.sub)\r\n    link = link.nextSub\r\n  }\r\n  queuedEffect.forEach(effect => effect.notify())\r\n}\r\n\r\n/**\r\n *\r\n * @param sub \u5F00\u59CB\u8FFD\u8E2A\u4F9D\u8D56\uFF0C\u5C06depsTail\u8BBE\u7F6E\u4E3Aundefined\r\n */\r\nexport function startTrack(sub) {\r\n  sub.depsTail = undefined\r\n}\r\n\r\n/**\r\n *\r\n * @param sub \u7ED3\u675F\u8FFD\u8E2A\uFF0C\u627E\u5230\u9700\u8981\u6E05\u7406\u7684\u4F9D\u8D56\uFF0C\u65AD\u5F00\u5173\u8054\u5173\u7CFB\r\n */\r\nexport function endTrack(sub) {\r\n  const depsTail = sub.depsTail\r\n  /**\r\n   * \u5982\u679CdepsTail\u6709\uFF0C\u5E76\u4E14depsTail\u8FD8\u6709nextDep,\u6E05\u9664\u4F9D\u8D56\u5173\u7CFB\r\n   * \u5982\u679CdepsTail\u6CA1\u6709\uFF0C\u5934\u8282\u70B9\u6709\uFF0C\u5168\u90E8\u6E05\u9664\r\n   */\r\n  if (depsTail) {\r\n    if (depsTail.nextDep) {\r\n      clearTracking(depsTail.nextDep)\r\n      depsTail.nextDep = undefined\r\n    }\r\n  } else if (sub.deps) {\r\n    clearTracking(sub.deps)\r\n    sub.deps = undefined\r\n  }\r\n}\r\n\r\n/**\r\n *\r\n * @param link \u6E05\u9664\u4F9D\u8D56\r\n */\r\nexport function clearTracking(link: Link) {\r\n  while (link) {\r\n    const { prevSub, nextSub, nextDep, dep } = link\r\n\r\n    /**\r\n     * \u5982\u679CprevSub \u6709 prevSub.nextSub\u6307\u5411nextSub\r\n     * \u5982\u679C\u6CA1\u6709\uFF0C\u662F\u5934\u8282\u70B9\uFF0C\u628Adep.subs\u6307\u5411nextSub\r\n     */\r\n    if (prevSub) {\r\n      prevSub.nextSub = nextSub\r\n      link.nextSub = undefined\r\n    } else {\r\n      dep.subs = nextSub\r\n    }\r\n\r\n    /**\r\n     * \u5982\u679CnextSub\u6709\uFF0C\u628AnextSub.prevSub\u6307\u5411\u4E0A\u4E00\u4E2A\r\n     *\u5982\u679C\u4E0B\u4E00\u4E2A\u6CA1\u6709\uFF0C\u662F\u5C3E\u8282\u70B9\uFF0C\u628AsubsTail\u6307\u5411\u4E0A\u4E00\u4E2A\r\n     */\r\n    if (nextSub) {\r\n      nextSub.prevSub = prevSub\r\n      link.prevSub = undefined\r\n    } else {\r\n      dep.subsTail = prevSub\r\n    }\r\n\r\n    link.dep = link.sub = undefined\r\n    link.nextDep = undefined\r\n    link = nextDep\r\n  }\r\n}\r\n", "import type { Link } from './system'\r\nimport { startTrack, endTrack } from './system'\r\n\r\n//\u7528\u6765\u4FDD\u5B58\u5F53\u524D\u6B63\u5728\u6267\u884C\u7684effect\u51FD\u6570\r\nexport let activeSub\r\n\r\nexport class ReactiveEffect {\r\n  /**\r\n   * \u4F9D\u8D56\u9879\u94FE\u8868\u7684\u5934\u8282\u70B9\r\n   */\r\n  deps: Link | undefined\r\n  /**\r\n   * \u4F9D\u8D56\u9879\u94FE\u8868\u7684\u5C3E\u8282\u70B9\r\n   */\r\n  depsTail: Link | undefined\r\n\r\n  constructor(public fn) {}\r\n\r\n  run() {\r\n    const prevSub = activeSub\r\n    //\u6BCF\u6B21\u6267\u884Cfn\u4E4B\u524D\uFF0C\u5427this\u653E\u5728activeSub\u4E0A\r\n    activeSub = this\r\n    //\u6807\u8BB0\u4E3Aundefined \u8868\u793A\u88ABdep\u89E6\u53D1\u4E86\u91CD\u65B0\u6267\u884C \u8981\u5C1D\u8BD5\u590D\u7528link\u8282\u70B9\r\n    startTrack(this)\r\n    try {\r\n      return this.fn()\r\n    } finally {\r\n      endTrack(this)\r\n      //\u6267\u884C\u5B8C\u4E4B\u540E \u628Aactive\u8BBE\u7F6E\u6210undefined\r\n      activeSub = prevSub\r\n    }\r\n  }\r\n\r\n  notify() {\r\n    this.scheduler()\r\n  }\r\n\r\n  scheduler() {\r\n    this.run()\r\n  }\r\n}\r\n\r\nexport function effect(fn, options) {\r\n  const e = new ReactiveEffect(fn)\r\n  // scheduler\r\n  Object.assign(e, options)\r\n  e.run()\r\n  /**\r\n   * \u7ED1\u5B9Athis\r\n   */\r\n  const runner = e.run.bind(e)\r\n  /**\r\n   * \u628A effect\u5B9E\u4F8B\u653E\u5230effect\u5C5E\u6027\u4E2D\r\n   */\r\n  runner.effect = e\r\n  return runner\r\n}\r\n", "import { activeSub } from './effect'\r\nimport { Link, link, propagate } from './system'\r\n\r\nenum ReactiveFlags {\r\n  IS_REF = '__v_isRef',\r\n}\r\n\r\n/**\r\n * Ref \u5F97\u7C7B\r\n */\r\nclass RefImpl {\r\n  //\u4FDD\u5B58\u5B9E\u9645\u7684\u503C\r\n  _value;\r\n  //ref\u6807\u8BB0 \u8BC1\u660E\u662F\u4E00\u4E2Aref\r\n  [ReactiveFlags.IS_REF] = true\r\n  /**\r\n   * \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5934\u8282\u70B9,head\r\n   */\r\n  subs: Link\r\n  /**\r\n   *\r\n   * \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5C3E\u8282\u70B9 \u7406\u89E3\u4E3Atail\r\n   */\r\n  subsTail: Link\r\n\r\n  constructor(value) {\r\n    this._value = value\r\n  }\r\n\r\n  get value() {\r\n    //\u6536\u96C6\u4F9D\u8D56\r\n    // console.log('\u6536\u96C6\u4F9D\u8D56', activeSub)\r\n    if (activeSub) {\r\n      trackRef(this)\r\n    }\r\n    return this._value\r\n  }\r\n\r\n  set value(newValue) {\r\n    this._value = newValue\r\n    //\u901A\u77E5effect\u51FD\u6570\u6267\u884C\r\n    triggerRef(this)\r\n  }\r\n}\r\n\r\nexport function ref(value) {\r\n  return new RefImpl(value)\r\n}\r\n/**\r\n * \u5224\u65AD\u662F\u4E0D\u662F\u4E00\u4E2Aref\r\n */\r\nexport function isRef(value) {\r\n  return !!(value && value[ReactiveFlags.IS_REF])\r\n}\r\n\r\n/**\r\n * \u6536\u96C6\u4F9D\u8D56\uFF0C\u5EFA\u7ACBref\u548Ceffect\u4E4B\u95F4\u7684\u94FE\u8868\u5173\u7CFB\r\n * @param dep\r\n */\r\nexport function trackRef(dep) {\r\n  if (activeSub) {\r\n    link(dep, activeSub)\r\n  }\r\n}\r\n\r\n/**\r\n * \u5173\u8054\u7684effect\u91CD\u65B0\u6267\u884C\r\n * @param dep\r\n *\r\n */\r\nexport function triggerRef(dep) {\r\n  if (dep.subs) {\r\n    propagate(dep.subs)\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": ["link", "effect"]
}
