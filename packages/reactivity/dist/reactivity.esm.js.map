{
  "version": 3,
  "sources": ["../src/system.ts", "../src/effect.ts", "../../shared/src/index.ts", "../src/dep.ts", "../src/baseHandlers.ts", "../src/reactive.ts", "../src/ref.ts", "../src/computed.ts", "../src/watch.ts"],
  "sourcesContent": ["/**\r\n * \u4F9D\u8D56\u9879\r\n */\r\nexport interface Dependency {\r\n  /**\r\n   * \u8BA2\u9605\u8005\u94FE\u8868\u5934\u8282\u70B9\r\n   */\r\n  subs: Link | undefined\r\n  subsTail: Link | undefined\r\n}\r\n\r\n/**\r\n * \u8BA2\u9605\u8005\r\n */\r\nexport interface Sub {\r\n  deps: Link | undefined\r\n  depsTail: Link | undefined\r\n  tracking: boolean\r\n}\r\nexport interface Link {\r\n  //\u8BA2\u9605\u8005\r\n  sub: Sub\r\n  //\u4E0B\u4E00\u4E2A\u8BA2\u9605\u8005\u8282\u70B9\r\n  nextSub: Link | undefined\r\n  //\u4E0A\u4E00\u4E2A\u8BA2\u9605\u8005\u8282\u70B9\r\n  prevSub: Link | undefined\r\n  //\u4F9D\u8D56\u9879\r\n  dep: Dependency\r\n  //\u4E0B\u4E00\u4E2A\u4F9D\u8D56\u9879\u8282\u70B9\r\n  nextDep: Link | undefined\r\n}\r\n\r\n// \u4FDD\u5B58\u5DF2\u7ECF\u88AB\u6E05\u7406\u6389\u7684\u8282\u70B9\uFF0C\u7559\u7740\u590D\u7528\r\nlet linkPool: Link\r\n\r\n/**\r\n * \u94FE\u63A5\u94FE\u8868\u5173\u7CFB\r\n * @param dep\r\n * @param sub\r\n */\r\nexport function link(dep, sub) {\r\n  // debugger\r\n  //\u590D\u7528\u94FE\u8868\u4F9D\u8D56\r\n  const currentDep = sub.depsTail\r\n  /**\r\n   * \u5982\u679C\u5934\u8282\u70B9\u6709\uFF0C\u5C3E\u8282\u70B9\u6CA1\u6709\uFF0C\u5C1D\u8BD5\u590D\u7528\u5934\u8282\u70B9\r\n   * \u5982\u679C\u5934\u8282\u70B9\u6709\uFF0C\u5C3E\u8282\u70B9\u4E5F\u6709\uFF0C\u5C1D\u8BD5\u590D\u7528nextDep\r\n   */\r\n  const nextDep = currentDep === undefined ? sub.deps : currentDep.nextDep\r\n  if (nextDep && nextDep.dep === dep) {\r\n    sub.depsTail = nextDep\r\n    return\r\n  }\r\n\r\n  //\u53EF\u904D\u5386dep.sub\u662F\u5426\u5EFA\u7ACB\u8FC7\u5173\u8054\u5173\u7CFB\uFF0C\u76F4\u63A5return,\u65F6\u95F4\u6362\u7A7A\u95F4\r\n\r\n  let newLink\r\n\r\n  /**\r\n   * \u5982\u679C\u6709linkPool,\u590D\u7528\r\n   */\r\n  if (linkPool) {\r\n    newLink = linkPool\r\n    linkPool = linkPool.nextDep\r\n    newLink.nextDep = nextDep\r\n    newLink.dep = dep\r\n    newLink.sub = sub\r\n  } else {\r\n    newLink = {\r\n      sub,\r\n      dep,\r\n      nextSub: undefined,\r\n      prevSub: undefined,\r\n      nextDep,\r\n    }\r\n  }\r\n\r\n  //\u5C06\u94FE\u8868\u8282\u70B9\u4E0Edep\u5EFA\u7ACB\u5173\u7CFB\r\n  /**\r\n   * \u5173\u8054\u94FE\u8868\u5173\u7CFB \u5206\u4E24\u79CD\u60C5\u51B5\r\n   * 1.\u5C3E\u8282\u70B9\u6709\uFF0C\u5F80\u5C3E\u8282\u70B9\u540E\u9762\u52A0\r\n   * 2.\u5C3E\u8282\u70B9\u6CA1\u6709\uFF0C\u7B2C\u4E00\u6B21\u52A0\uFF0C\u52A0\u5230\u5934\u8282\u70B9\r\n   */\r\n  if (dep.subsTail) {\r\n    dep.subsTail.nextSub = newLink\r\n    newLink.prevSub = dep.subsTail\r\n    dep.subsTail = newLink\r\n  } else {\r\n    dep.subs = newLink\r\n    dep.subsTail = newLink\r\n  }\r\n\r\n  //\u5C06\u94FE\u8868\u8282\u70B9\u4E0Esub\u5EFA\u7ACB\u5173\u7CFB\r\n  /**\r\n   * \u5173\u8054\u94FE\u8868\u5173\u7CFB \u5206\u4E24\u79CD\u60C5\u51B5\r\n   * 1.\u5C3E\u8282\u70B9\u6709\uFF0C\u5F80\u5C3E\u8282\u70B9\u540E\u9762\u52A0\r\n   * 2.\u5C3E\u8282\u70B9\u6CA1\u6709\uFF0C\u7B2C\u4E00\u6B21\u52A0\uFF0C\u52A0\u5230\u5934\u8282\u70B9\r\n   */\r\n  if (sub.depsTail) {\r\n    sub.depsTail.nextDep = newLink\r\n    sub.depsTail = newLink\r\n  } else {\r\n    sub.deps = newLink\r\n    sub.depsTail = newLink\r\n  }\r\n}\r\n\r\nfunction processComputedUpdate(sub) {\r\n  /**\r\n   * \u66F4\u65B0\u8BA1\u7B97\u5C5E\u6027\r\n   * 1.\u8C03\u7528update\r\n   * 2.\u901A\u77E5subs\u94FE\u8868\u4E0A\u6240\u6709sub\u91CD\u65B0\u6267\u884C\r\n   */\r\n  if (sub.subs && sub.update()) {\r\n    sub.update()\r\n    propagate(sub.subs)\r\n  }\r\n}\r\n\r\n/**\r\n * \u4F20\u64AD\u66F4\u65B0\r\n * @param subs\r\n */\r\nexport function propagate(subs) {\r\n  let link = subs\r\n  let queuedEffect = []\r\n  while (link) {\r\n    const sub = link.sub\r\n    if (!sub.tracking && !sub.dirty) {\r\n      sub.dirty = true\r\n      if ('update' in sub) {\r\n        processComputedUpdate(sub)\r\n      } else {\r\n        queuedEffect.push(sub)\r\n      }\r\n    }\r\n    link = link.nextSub\r\n  }\r\n  queuedEffect.forEach(effect => effect.notify())\r\n}\r\n\r\n/**\r\n *\r\n * @param sub \u5F00\u59CB\u8FFD\u8E2A\u4F9D\u8D56\uFF0C\u5C06depsTail\u8BBE\u7F6E\u4E3Aundefined\r\n */\r\nexport function startTrack(sub) {\r\n  sub.depsTail = undefined\r\n  sub.tracking = true\r\n}\r\n\r\n/**\r\n *\r\n * @param sub \u7ED3\u675F\u8FFD\u8E2A\uFF0C\u627E\u5230\u9700\u8981\u6E05\u7406\u7684\u4F9D\u8D56\uFF0C\u65AD\u5F00\u5173\u8054\u5173\u7CFB\r\n */\r\nexport function endTrack(sub) {\r\n  sub.tracking = false\r\n  const depsTail = sub.depsTail\r\n  sub.dirty = false\r\n  /**\r\n   * \u5982\u679CdepsTail\u6709\uFF0C\u5E76\u4E14depsTail\u8FD8\u6709nextDep,\u6E05\u9664\u4F9D\u8D56\u5173\u7CFB\r\n   * \u5982\u679CdepsTail\u6CA1\u6709\uFF0C\u5934\u8282\u70B9\u6709\uFF0C\u5168\u90E8\u6E05\u9664\r\n   */\r\n  if (depsTail) {\r\n    if (depsTail.nextDep) {\r\n      clearTracking(depsTail.nextDep)\r\n      depsTail.nextDep = undefined\r\n    }\r\n  } else if (sub.deps) {\r\n    clearTracking(sub.deps)\r\n    sub.deps = undefined\r\n  }\r\n}\r\n\r\n/**\r\n *\r\n * @param link \u6E05\u9664\u4F9D\u8D56\r\n */\r\nexport function clearTracking(link: Link) {\r\n  while (link) {\r\n    const { prevSub, nextSub, nextDep, dep } = link\r\n\r\n    /**\r\n     * \u5982\u679CprevSub \u6709 prevSub.nextSub\u6307\u5411nextSub\r\n     * \u5982\u679C\u6CA1\u6709\uFF0C\u662F\u5934\u8282\u70B9\uFF0C\u628Adep.subs\u6307\u5411nextSub\r\n     */\r\n    if (prevSub) {\r\n      prevSub.nextSub = nextSub\r\n      link.nextSub = undefined\r\n    } else {\r\n      dep.subs = nextSub\r\n    }\r\n\r\n    /**\r\n     * \u5982\u679CnextSub\u6709\uFF0C\u628AnextSub.prevSub\u6307\u5411\u4E0A\u4E00\u4E2A\r\n     *\u5982\u679C\u4E0B\u4E00\u4E2A\u6CA1\u6709\uFF0C\u662F\u5C3E\u8282\u70B9\uFF0C\u628AsubsTail\u6307\u5411\u4E0A\u4E00\u4E2A\r\n     */\r\n    if (nextSub) {\r\n      nextSub.prevSub = prevSub\r\n      link.prevSub = undefined\r\n    } else {\r\n      dep.subsTail = prevSub\r\n    }\r\n\r\n    link.dep = link.sub = undefined\r\n\r\n    //\u5C06\u6E05\u7406\u7684\u8282\u70B9\u7ED9linkPool\r\n    link.nextDep = linkPool\r\n    linkPool = link\r\n\r\n    link = nextDep\r\n  }\r\n}\r\n", "import type { Link, Sub } from './system'\r\nimport { startTrack, endTrack } from './system'\r\n\r\n//\u7528\u6765\u4FDD\u5B58\u5F53\u524D\u6B63\u5728\u6267\u884C\u7684effect\u51FD\u6570\r\nexport let activeSub\r\n\r\nexport function setActiveSub(sub) {\r\n  activeSub = sub\r\n}\r\n\r\nexport class ReactiveEffect implements Sub {\r\n  active = true\r\n  /**\r\n   * \u4F9D\u8D56\u9879\u94FE\u8868\u7684\u5934\u8282\u70B9\r\n   */\r\n  deps: Link | undefined\r\n  /**\r\n   * \u4F9D\u8D56\u9879\u94FE\u8868\u7684\u5C3E\u8282\u70B9\r\n   */\r\n  depsTail: Link | undefined\r\n\r\n  tracking = false\r\n\r\n  dirty = false\r\n\r\n  constructor(public fn) {}\r\n\r\n  run() {\r\n    if (!this.active) {\r\n      return this.fn()\r\n    }\r\n    const prevSub = activeSub\r\n    //\u6BCF\u6B21\u6267\u884Cfn\u4E4B\u524D\uFF0C\u5427this\u653E\u5728activeSub\u4E0A\r\n    setActiveSub(this)\r\n    //\u6807\u8BB0\u4E3Aundefined \u8868\u793A\u88ABdep\u89E6\u53D1\u4E86\u91CD\u65B0\u6267\u884C \u8981\u5C1D\u8BD5\u590D\u7528link\u8282\u70B9\r\n    startTrack(this)\r\n    try {\r\n      return this.fn()\r\n    } finally {\r\n      endTrack(this)\r\n      //\u6267\u884C\u5B8C\u4E4B\u540E \u628Aactive\u8BBE\u7F6E\u6210undefined\r\n      setActiveSub(prevSub)\r\n    }\r\n  }\r\n\r\n  notify() {\r\n    this.scheduler()\r\n  }\r\n\r\n  scheduler() {\r\n    this.run()\r\n  }\r\n\r\n  stop() {\r\n    if (this.active) {\r\n      startTrack(this)\r\n      endTrack(this)\r\n      this.active = false\r\n    }\r\n  }\r\n}\r\n\r\nexport function effect(fn, options) {\r\n  const e = new ReactiveEffect(fn)\r\n  // scheduler\r\n  Object.assign(e, options)\r\n  e.run()\r\n  /**\r\n   * \u7ED1\u5B9Athis\r\n   */\r\n  const runner = e.run.bind(e)\r\n  /**\r\n   * \u628A effect\u5B9E\u4F8B\u653E\u5230effect\u5C5E\u6027\u4E2D\r\n   */\r\n  runner.effect = e\r\n  return runner\r\n}\r\n", "export function isObject(obj) {\r\n  return obj !== null && typeof obj === 'object'\r\n}\r\n\r\n/**\r\n * \u5224\u65AD\u503C\u6709\u6CA1\u6709\u53D1\u751F\u8FC7\u53D8\u5316\uFF0C\u5982\u679C\u53D1\u751F\u8FC7\u8FD4\u56DEtrue\r\n * @param oldValue\r\n * @param newValue\r\n * @returns\r\n */\r\nexport function hasChanged(oldValue, newValue) {\r\n  return !Object.is(oldValue, newValue)\r\n}\r\n\r\nexport function isFunction(value) {\r\n  return typeof value === 'function'\r\n}\r\n", "import { activeSub } from './effect'\r\nimport { link, propagate } from './system'\r\nimport type { Link } from './system'\r\n\r\n/**\r\n * \u7ED1\u5B9Atarget\u7684key\u5173\u8054\u7684\u6240\u6709Dep\r\n */\r\nconst targetMap = new WeakMap()\r\n\r\nexport function track(target, key) {\r\n  if (!activeSub) {\r\n    return\r\n  }\r\n\r\n  let depsMap = targetMap.get(target)\r\n\r\n  if (!depsMap) {\r\n    /**\r\n     * \u5982\u679C\u6CA1\u6709depsMap\uFF0C\u8BF4\u660E\u4E4B\u524D\u6CA1\u6536\u96C6\u8FC7\u4EFB\u4F55\u8FD9\u4E2A\u5BF9\u8C61\u7684key\r\n     * \u521B\u5EFA\u4E00\u4E2A\u65B0\u7684\uFF0C\u4FDD\u5B58target\u548CdepsMap\u4E4B\u95F4\u7684\u5173\u7CFB\r\n     */\r\n    depsMap = new Map()\r\n    targetMap.set(target, depsMap)\r\n  }\r\n\r\n  /**\r\n   * \u627Edep\r\n   */\r\n  let dep = depsMap.get(key)\r\n\r\n  if (!dep) {\r\n    /**\r\n     * \u7B2C\u4E00\u6B21\u6536\u96C6\u8FD9\u4E2A\u5BF9\u8C61\uFF0C\u521B\u5EFA\u65B0\u7684\r\n     */\r\n    dep = new Dep()\r\n    depsMap.set(key, dep)\r\n  }\r\n\r\n  link(dep, activeSub)\r\n}\r\n\r\nexport function trigger(target, key) {\r\n  /**\r\n   * \u627EdepsMap\r\n   */\r\n  const depsMap = targetMap.get(target)\r\n  if (!depsMap) {\r\n    /**\r\n     * \u8BE5\u5BF9\u8C61\u6CA1\u6709\u4EFB\u4F55\u5C5E\u6027\u5728sub\u4E2D\u8BBF\u95EE\u8FC7\r\n     */\r\n    return\r\n  }\r\n\r\n  /**\r\n   * \u627E\u5230key\u5BF9\u5E94\u7684dep\r\n   */\r\n  const dep = depsMap.get(key)\r\n  if (!dep) {\r\n    //\u8FD9\u4E2Akey\u6CA1\u6709\u5728sub\u4E2D\u8BBF\u95EE\u8FC7\r\n    return\r\n  }\r\n\r\n  propagate(dep.subs)\r\n}\r\n\r\nclass Dep {\r\n  /**\r\n   * \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5934\u8282\u70B9,head\r\n   */\r\n  subs: Link\r\n  /**\r\n   *\r\n   * \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5C3E\u8282\u70B9 \u7406\u89E3\u4E3Atail\r\n   */\r\n  subsTail: Link\r\n  constructor() {}\r\n}\r\n", "import { hasChanged, isObject } from '@vue/shared'\r\nimport { track, trigger } from './dep'\r\nimport { isRef } from './ref'\r\nimport { reactive } from './reactive'\r\n\r\nexport const mutableHandlers = {\r\n  get(target, key, receiver) {\r\n    /**\r\n     * \u6536\u96C6\u4F9D\u8D56\uFF0C\u7ED1\u5B9Atarget\u4E2D\u67D0\u4E2Akey\u548Csub\u7684\u8054\u7CFB\r\n     */\r\n\r\n    track(target, key)\r\n\r\n    const res = Reflect.get(target, key, receiver)\r\n\r\n    if (isRef(res)) {\r\n      return res.value\r\n    }\r\n\r\n    if (isObject(res)) {\r\n      return reactive(res)\r\n    }\r\n\r\n    /**\r\n     * receiver \u7528\u6765\u4FDD\u8BC1\u8BBF\u95EE\u5668\u91CC\u9762\u7684this\u6307\u5411\u4EE3\u7406\u5BF9\u8C61\r\n     */\r\n    return Reflect.get(target, key, receiver)\r\n  },\r\n\r\n  set(target, key, newValue, receiver) {\r\n    const oldValue = target[key]\r\n    /**\r\n     *\u89E6\u53D1\u66F4\u65B0\uFF0Cset\u7684\u65F6\u5019\u901A\u77E5\u4E4B\u524D\u6536\u96C6\u7684\u4F9D\u8D56\u91CD\u65B0\u6267\u884C\r\n     */\r\n\r\n    const res = Reflect.set(target, key, newValue, receiver)\r\n\r\n    /**\r\n     * \u5982\u679C\u66F4\u65B0\u4E4B\u524D\u662F\u4E00\u4E2Aref\uFF0C\u90A3\u4E48\u4F1A\u4FEE\u6539\u539F\u6765\u7684\u503C\r\n     * \u5982\u679C\u4E0D\u662Fcontinue\r\n     */\r\n    if (isRef(oldValue) && !isRef(newValue)) {\r\n      oldValue.value = newValue\r\n      return res\r\n    }\r\n\r\n    if (hasChanged(oldValue, newValue)) {\r\n      trigger(target, key)\r\n    }\r\n\r\n    return res\r\n  },\r\n}\r\n", "import { isObject } from '@vue/shared'\r\nimport { mutableHandlers } from './baseHandlers'\r\n\r\nexport function reactive(target) {\r\n  return createReactiveObject(target)\r\n}\r\n\r\n/**\r\n * \u4FDD\u5B58target\u548C\u54CD\u5E94\u5F0F\u5BF9\u8C61\u4E4B\u95F4\u7684\u5173\u8054\u5173\u7CFB\r\n * target => proxy\r\n */\r\nconst reactiveMap = new WeakMap()\r\n\r\n/**\r\n * \u4FDD\u5B58\u6240\u6709reactive\u521B\u5EFA\u51FA\u6765\u7684\u54CD\u5E94\u5F0F\u5BF9\u8C61\r\n */\r\nconst reactiveSet = new WeakSet()\r\n\r\nfunction createReactiveObject(target) {\r\n  /**\r\n   * reactive\u5FC5\u987B\u63A5\u6536\u4E00\u4E2A\u5BF9\u8C61\r\n   */\r\n  if (!isObject(target)) {\r\n    return target\r\n  }\r\n\r\n  if (reactiveSet.has(target)) {\r\n    return target\r\n  }\r\n\r\n  const exitingProxy = reactiveMap.get(target)\r\n  if (exitingProxy) {\r\n    /**\r\n     * \u5982\u679C\u8BE5\u5BF9\u8C61\u521B\u5EFA\u8FC7\u54CD\u5E94\u5F0F\u5BF9\u8C61\uFF0C\u8FD4\u56DE\u521B\u5EFA\u8FC7\u7684\r\n     */\r\n    return exitingProxy\r\n  }\r\n\r\n  /**\r\n   * \u521B\u5EFA\u4EE3\u7406\u5BF9\u8C61\r\n   */\r\n  const proxy = new Proxy(target, mutableHandlers)\r\n\r\n  /**\r\n   * \u4FDD\u5B58target\u548Cproxy\u4E4B\u95F4\u5173\u8054\u5173\u7CFB\r\n   */\r\n  reactiveMap.set(target, proxy)\r\n\r\n  /**\r\n   * \u4FDD\u5B58\u521B\u5EFA\u8FC7\u7684\u54CD\u5E94\u5F0F\u5BF9\u8C61\r\n   */\r\n  reactiveSet.add(proxy)\r\n\r\n  return proxy\r\n}\r\n\r\n/**\r\n *\r\n * @param target \u5224\u65AD\u662F\u4E0D\u662F\u54CD\u5E94\u5F0F\u5BF9\u8C61\r\n * @returns\r\n */\r\nexport function isReactive(target) {\r\n  return reactiveSet.has(target)\r\n}\r\n", "import { activeSub } from './effect'\r\nimport { Dependency, Link, link, propagate } from './system'\r\nimport { isReactive, reactive } from './reactive'\r\nimport { hasChanged } from '@vue/shared'\r\n\r\nexport enum ReactiveFlags {\r\n  IS_REF = '__v_isRef',\r\n}\r\n\r\n/**\r\n * Ref \u5F97\u7C7B\r\n */\r\nclass RefImpl implements Dependency {\r\n  //\u4FDD\u5B58\u5B9E\u9645\u7684\u503C\r\n  _value;\r\n\r\n  //ref\u6807\u8BB0 \u8BC1\u660E\u662F\u4E00\u4E2Aref\r\n  [ReactiveFlags.IS_REF] = true\r\n\r\n  /**\r\n   * \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5934\u8282\u70B9,head\r\n   */\r\n  subs: Link\r\n  /**\r\n   *\r\n   * \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5C3E\u8282\u70B9 \u7406\u89E3\u4E3Atail\r\n   */\r\n  subsTail: Link\r\n\r\n  constructor(value) {\r\n    this._value = isReactive(value) ? reactive(value) : value\r\n  }\r\n\r\n  get value() {\r\n    //\u6536\u96C6\u4F9D\u8D56\r\n    // console.log('\u6536\u96C6\u4F9D\u8D56', activeSub)\r\n    if (activeSub) {\r\n      trackRef(this)\r\n    }\r\n    return this._value\r\n  }\r\n\r\n  set value(newValue) {\r\n    /**\r\n     * \u53EA\u6709newValue\u4E0D\u7B49\u4E8EoldValue\u624D\u66F4\u65B0\r\n     */\r\n    if (hasChanged(newValue, this._value)) {\r\n      this._value = isReactive(newValue) ? reactive(newValue) : newValue\r\n      //\u901A\u77E5effect\u51FD\u6570\u6267\u884C\r\n      triggerRef(this)\r\n    }\r\n  }\r\n}\r\n\r\nexport function ref(value) {\r\n  return new RefImpl(value)\r\n}\r\n/**\r\n * \u5224\u65AD\u662F\u4E0D\u662F\u4E00\u4E2Aref\r\n */\r\nexport function isRef(value) {\r\n  return !!(value && value[ReactiveFlags.IS_REF])\r\n}\r\n\r\n/**\r\n * \u6536\u96C6\u4F9D\u8D56\uFF0C\u5EFA\u7ACBref\u548Ceffect\u4E4B\u95F4\u7684\u94FE\u8868\u5173\u7CFB\r\n * @param dep\r\n */\r\nexport function trackRef(dep) {\r\n  if (activeSub) {\r\n    link(dep, activeSub)\r\n  }\r\n}\r\n\r\n/**\r\n * \u5173\u8054\u7684effect\u91CD\u65B0\u6267\u884C\r\n * @param dep\r\n *\r\n */\r\nexport function triggerRef(dep) {\r\n  if (dep.subs) {\r\n    propagate(dep.subs)\r\n  }\r\n}\r\n", "import { activeSub, ReactiveEffect, setActiveSub } from './effect'\r\nimport { hasChanged, isFunction } from '@vue/shared'\r\nimport { ReactiveFlags } from './ref'\r\nimport { Dependency, endTrack, Link, link, startTrack, Sub } from './system'\r\n\r\nclass ComputedRefImpl implements Dependency, Sub {\r\n  //computed\u4E5F\u662F\u4E00\u4E2Aref\r\n  [ReactiveFlags.IS_REF] = true\r\n\r\n  //\u4FDD\u5B58fn\u7684\u8FD4\u56DE\u503C\r\n  _value\r\n\r\n  //\u4F5C\u4E3Adep\r\n  /**\r\n   * \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5934\u8282\u70B9,head\r\n   */\r\n  subs: Link\r\n  /**\r\n   *\r\n   * \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5C3E\u8282\u70B9 \u7406\u89E3\u4E3Atail\r\n   */\r\n  subsTail: Link\r\n\r\n  //\u4F5C\u4E3Asub\r\n  /**\r\n   * \u4F9D\u8D56\u9879\u94FE\u8868\u7684\u5934\u8282\u70B9\r\n   */\r\n  deps: Link | undefined\r\n  /**\r\n   * \u4F9D\u8D56\u9879\u94FE\u8868\u7684\u5C3E\u8282\u70B9\r\n   */\r\n  depsTail: Link | undefined\r\n\r\n  tracking = false\r\n\r\n  //\u8BA1\u7B97\u5C5E\u6027\u810F\u4E0D\u810F\uFF0C\u5982\u679C\u4E3A\u810F\uFF0Cget value\u7684\u65F6\u5019\u9700\u8981\u6267\u884Cupdate\r\n  dirty = true\r\n\r\n  constructor(\r\n    public fn, //getter\r\n    private setter,\r\n  ) {}\r\n\r\n  get value() {\r\n    if (this.dirty) {\r\n      this.update()\r\n    }\r\n    /**\r\n     * \u548Csub\u5EFA\u7ACB\u5173\u8054\u5173\u7CFB\r\n     */\r\n    if (activeSub) {\r\n      link(this, activeSub)\r\n    }\r\n    return this._value\r\n  }\r\n\r\n  set value(newValue) {\r\n    if (this.setter) {\r\n      this.setter(newValue)\r\n    } else {\r\n      console.warn('no')\r\n    }\r\n  }\r\n\r\n  update() {\r\n    /**\r\n     * \u5B9E\u73B0sub\u7684\u529F\u80FD\uFF0C\u6267\u884Cfn\u671F\u95F4\uFF0C\u6536\u96C6fn\u6267\u884C\u8FC7\u7A0B\u4E2D\u8BBF\u95EE\u5230\u7684\u54CD\u5E94\u5F0F\u6570\u636E\r\n     * \u5EFA\u7ACBdep\u4E0Esub\u7684\u8054\u7CFB\r\n     */\r\n    const prevSub = activeSub\r\n    //\u6BCF\u6B21\u6267\u884Cfn\u4E4B\u524D\uFF0C\u5427this\u653E\u5728activeSub\u4E0A\r\n    setActiveSub(this)\r\n    //\u6807\u8BB0\u4E3Aundefined \u8868\u793A\u88ABdep\u89E6\u53D1\u4E86\u91CD\u65B0\u6267\u884C \u8981\u5C1D\u8BD5\u590D\u7528link\u8282\u70B9\r\n    startTrack(this)\r\n    try {\r\n      const oldValue = this._value\r\n      this._value = this.fn()\r\n      return hasChanged(this._value, oldValue)\r\n    } finally {\r\n      endTrack(this)\r\n      //\u6267\u884C\u5B8C\u4E4B\u540E \u628Aactive\u8BBE\u7F6E\u6210undefined\r\n      setActiveSub(prevSub)\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * \u8BA1\u7B97\u5C5E\u6027\r\n * @param getterOrOptions \u6709\u53EF\u80FD\u662F\u51FD\u6570\uFF0C\u4E5F\u53EF\u80FD\u662F\u5BF9\u8C61\u5BF9\u8C61\u6709get\u548Cset\r\n */\r\nexport function computed(getterOrOptions) {\r\n  let getter\r\n  let setter\r\n\r\n  if (isFunction(getterOrOptions)) {\r\n    /**\r\n     * computed(()=>{})\r\n     */\r\n    getter = getterOrOptions\r\n  } else {\r\n    /**\r\n     * computed({\r\n     * get()\r\n     * set()\r\n     * })\r\n     */\r\n    getter = getterOrOptions.get\r\n    setter = getterOrOptions.set\r\n  }\r\n\r\n  return new ComputedRefImpl(getter, setter)\r\n}\r\n", "import { ReactiveEffect } from './effect'\r\nimport { isRef } from './ref'\r\n\r\nexport function watch(source, cb, options) {\r\n  const { immediate, once, deep } = options || {}\r\n\r\n  if (once) {\r\n    const _cb = cb\r\n    cb = (...args) => {\r\n      _cb(...args)\r\n      stop()\r\n    }\r\n  }\r\n\r\n  let getter\r\n\r\n  if (isRef(source)) {\r\n    getter = () => source.value\r\n  }\r\n\r\n  let oldValue\r\n\r\n  function job() {\r\n    //\u6267\u884Ceffect.run\u62FF\u5230getter\u7684\u8FD4\u56DE\u503C\uFF0C\u4E0D\u80FD\u76F4\u63A5\u6267\u884Cgetter \u56E0\u4E3A\u8981\u6536\u96C6\u4F9D\u8D56\r\n    const newValue = effect.run()\r\n    //\u6267\u884C\u7528\u6237\u56DE\u8C03\r\n    cb(newValue, oldValue)\r\n    oldValue = newValue\r\n  }\r\n\r\n  const effect = new ReactiveEffect(getter)\r\n\r\n  effect.scheduler = job\r\n\r\n  if (immediate) {\r\n    job()\r\n  } else {\r\n    //\u62FF\u5230oldValue,\u5E76\u4E14\u6536\u96C6\u4F9D\u8D56\r\n    oldValue = effect.run()\r\n  }\r\n\r\n  function stop() {\r\n    effect.stop()\r\n  }\r\n\r\n  return stop\r\n}\r\n"],
  "mappings": "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",
  "names": ["link", "effect", "ReactiveFlags", "effect"]
}
